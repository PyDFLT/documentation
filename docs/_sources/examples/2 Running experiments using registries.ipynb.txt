{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "8065ef7d7ba49efe",
   "metadata": {},
   "source": [
    "# 2 Running experiments using registries\n",
    "PyDFLT includes a few tools that make it easier to run experiments. This notebook introduces registries that have predefined configurations of methods, models and data from literature. In 2.2 the usage of configs and utils is shown to be able to easily run more extended experiments."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "91e4b7d8b7fcdee9",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import sys\n",
    "\n",
    "path_to_project = os.path.dirname(os.path.abspath(\"\")) + \"/\"\n",
    "sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(\"PyDFLT\"))))\n",
    "# Jupyter is not installed in your venv automatically, if you used uv the following will install jupyter: uv sync --group examples"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c2d2656eb94ad56",
   "metadata": {},
   "source": [
    "## 2.1 Registries\n",
    "To make it easy to use different models, data and DFL methods from literature, we created different registries in `src.registries`. These 3 categories are stored here with the settings as they are relevant and appear in literature. It also makes it easy to specify a base version of a model, data or decision maker. Below are the currently stored registries. In the files themselves there are some comments regarding works that use about the same configuration, with slightly different parameters\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "872ad70b8415c833",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T13:32:40.013563Z",
     "start_time": "2025-10-01T13:32:37.078343Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Auto-Sklearn cannot be imported.\n",
      "Name: differentiable\n",
      "Class/function: <class 'src.decision_makers.differentiable_decision_maker.DifferentiableDecisionMaker'>\n",
      "Parameters: {'learning_rate': 0.001, 'device_str': 'cpu', 'loss_function_str': 'regret', 'predictor_str': 'MLP'}\n",
      "\n",
      "Name: PFL linear\n",
      "Class/function: <class 'src.decision_makers.differentiable_decision_maker.DifferentiableDecisionMaker'>\n",
      "Parameters: {'learning_rate': 0.001, 'device_str': 'cpu', 'loss_function_str': 'mse', 'predictor_str': 'MLP', 'predictor_kwargs': {'num_hidden_layers': 0}}\n",
      "\n",
      "Name: SPO+ linear\n",
      "Class/function: <class 'src.decision_makers.differentiable_decision_maker.DifferentiableDecisionMaker'>\n",
      "Parameters: {'learning_rate': 0.001, 'device_str': 'cpu', 'loss_function_str': 'SPOPlus', 'predictor_str': 'MLP', 'predictor_kwargs': {'num_hidden_layers': 0}}\n",
      "\n",
      "Name: SFGE\n",
      "Class/function: <class 'src.decision_makers.sfge_decision_maker.SFGEDecisionMaker'>\n",
      "Parameters: {'learning_rate': 0.01, 'batch_size': 32, 'device_str': 'cpu', 'loss_function_str': 'regret', 'predictor_str': 'MLP', 'noisifier_kwargs': {'sigma_setting': 'independent'}}\n",
      "\n",
      "Name: Lancer\n",
      "Class/function: <class 'src.decision_makers.lancer_decision_maker.LancerDecisionMaker'>\n",
      "Parameters: {'learning_rate': 0.01, 'batch_size': 32, 'device_str': 'cpu', 'predictor_str': 'MLP'}\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from src.registries.decision_makers import decision_maker_registry\n",
    "from src.utils.load import print_registry\n",
    "\n",
    "print_registry(decision_maker_registry)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "60ec94b65b9b6eac",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T13:32:40.021890Z",
     "start_time": "2025-10-01T13:32:40.019955Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Name: knapsack_2D_Tang2022\n",
      "Class/function: <class 'src.concrete_models.grbpy_knapsack.GRBPYKnapsackModel'>\n",
      "Parameters: {'num_decisions': 32, 'capacity': 20, 'weights_lb': 3, 'weights_ub': 8, 'dimension': 2, 'seed': 5}\n",
      "\n",
      "Name: shortest_path\n",
      "Class/function: <class 'src.concrete_models.grbpy_shortest_path.ShortestPath'>\n",
      "Parameters: {'grid': (5, 5)}\n",
      "\n",
      "Name: WSMC_Silvestri2024\n",
      "Class/function: <class 'src.concrete_models.grbpy_two_stage_weighted_set_multi_cover.WeightedSetMultiCover'>\n",
      "Parameters: {'num_items': 5, 'num_covers': 25, 'penalty': 5, 'cover_costs_lb': 1, 'cover_costs_ub': 100, 'Silvestri2024': True, 'seed': 5}\n",
      "\n",
      "Name: knapsack_continuous\n",
      "Class/function: <class 'src.concrete_models.cvxpy_knapsack.CVXPYDiffKnapsackModel'>\n",
      "Parameters: {'num_decisions': 10, 'capacity': 20, 'values_lb': 3, 'values_ub': 8, 'dimension': 2, 'seed': 5}\n",
      "\n",
      "Name: knapsack_2_stage\n",
      "Class/function: <class 'src.concrete_models.grbpy_two_stage_knapsack.TwoStageKnapsack'>\n",
      "Parameters: {'num_decision': 10, 'capacity': 20, 'penalty_add': 0.1, 'penalty_remove': 10, 'values_lb': 3, 'values_ub': 8, 'seed': 5}\n",
      "\n",
      "Name: wsmc_recovery_5x25\n",
      "Class/function: <class 'src.concrete_models.grbpy_two_stage_weighted_set_multi_cover.WeightedSetMultiCover'>\n",
      "Parameters: {'num_items': 5, 'num_covers': 25, 'penalty': 5, 'cover_costs_lb': 5, 'cover_costs_ub': 50, 'recovery_ratio': 0.8, 'seed': 5}\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from src.registries.models import model_registry\n",
    "\n",
    "print_registry(model_registry)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "8f767d403ed323e5",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T13:32:40.084020Z",
     "start_time": "2025-10-01T13:32:40.082210Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Name: load_data_from_dict\n",
      "Class/function: <function load_data_from_dict at 0x13574fa60>\n",
      "Parameters: {'path': None}\n",
      "\n",
      "Name: shortest_path\n",
      "Class/function: <function gen_data_shortestpath at 0x121c0e5c0>\n",
      "Parameters: {'seed': 5, 'num_data': 2000, 'num_features': 5, 'grid': (5, 5), 'polynomial_degree': 6, 'noise_width': 0.5}\n",
      "\n",
      "Name: knapsack\n",
      "Class/function: <function gen_data_knapsack at 0x121c0e480>\n",
      "Parameters: {'seed': 5, 'num_data': 2000, 'num_features': 5, 'num_items': 10, 'dimension': 2, 'polynomial_degree': 6, 'noise_width': 0.5}\n",
      "\n",
      "Name: WSMC_Silvestri2024\n",
      "Class/function: <function gen_data_wsmc at 0x130de7ec0>\n",
      "Parameters: {'seed': 5, 'num_data': 2500, 'num_features': 5, 'num_items': 10, 'degree': 5, 'noise_width': 0.5}\n",
      "\n"
     ]
    }
   ],
   "source": [
    "from src.registries.data import data_registry\n",
    "\n",
    "print_registry(data_registry)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "92ae4fc6d3240d48",
   "metadata": {},
   "source": "With these registries one can simply load a certain model, data generation and method. For example, if we want to apply DFL ot a shortest path problem using SPO+ [1] with a linear predictor, one can use:"
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "ced30aba00e4706e",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T13:32:43.281349Z",
     "start_time": "2025-10-01T13:32:40.110978Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Set parameter Username\n",
      "Set parameter LicenseID to value 2612263\n",
      "Academic license - for non-commercial use only - expires 2026-01-20\n",
      "Set parameter FeasibilityTol to value 1e-06\n",
      "Generating data using shortest_path\n",
      "Computing optimal decisions for the entire dataset...\n",
      "Optimal decisions computed and added to dataset.\n",
      "Computing optimal objectives for the entire dataset...\n",
      "Optimal objectives computed and added to dataset.\n",
      "Shuffling indices before splitting...\n",
      "Dataset split completed: Train=1400, Validation=300, Test=300\n",
      "Problem mode set to: train\n",
      "Problem mode set to: train\n",
      "Num of cores: 1\n",
      "Epoch 0/3: Starting initial validation...\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3144\n",
      "validation/mse_mean: 2.9586\n",
      "validation/arc_costs_mean: 0.8145\n",
      "validation/rel_regret_mean: 1.2962\n",
      "validation/select_arc_mean: 0.2000\n",
      "validation/objective_mean: 6.0792\n",
      "validation/abs_regret_mean: 2.8480\n",
      "Initial best validation metric (abs_regret): 2.847959518432617\n",
      "Starting training...\n",
      "Epoch: 1/3\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 0.5058\n",
      "validation/sym_rel_regret_mean: 0.3144\n",
      "train/objective_mean: 3.5516\n",
      "train/loss_mean: 3.7989\n",
      "train/sym_rel_regret_mean: 0.0739\n",
      "validation/mse_mean: 2.9586\n",
      "validation/arc_costs_mean: 0.8145\n",
      "validation/rel_regret_mean: 1.2962\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 3.3784\n",
      "train/solver_calls_mean: 1019.8182\n",
      "train/rel_regret_mean: 0.1969\n",
      "validation/objective_mean: 6.0792\n",
      "validation/abs_regret_mean: 2.8480\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 0.5058\n",
      "validation/sym_rel_regret_mean: 0.1864\n",
      "train/objective_mean: 3.5516\n",
      "train/loss_mean: 3.7989\n",
      "train/sym_rel_regret_mean: 0.0739\n",
      "validation/mse_mean: 3.1112\n",
      "validation/arc_costs_mean: 0.7623\n",
      "validation/rel_regret_mean: 0.7190\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 3.3784\n",
      "train/solver_calls_mean: 1019.8182\n",
      "train/rel_regret_mean: 0.1969\n",
      "validation/objective_mean: 4.8626\n",
      "validation/abs_regret_mean: 1.6313\n",
      "Validation evaluation (abs_regret): 0.4147034287452698\n",
      "New best validation evaluation (abs_regret): 0.4147034287452698 (was 2.847959518432617)\n",
      "Epoch: 2/3\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 0.4282\n",
      "validation/sym_rel_regret_mean: 0.1864\n",
      "train/objective_mean: 3.4738\n",
      "train/loss_mean: 3.2933\n",
      "train/sym_rel_regret_mean: 0.0647\n",
      "validation/mse_mean: 3.1112\n",
      "validation/arc_costs_mean: 0.7623\n",
      "validation/rel_regret_mean: 0.7190\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 3.2610\n",
      "train/solver_calls_mean: 1869.8182\n",
      "train/rel_regret_mean: 0.1657\n",
      "validation/objective_mean: 4.8626\n",
      "validation/abs_regret_mean: 1.6313\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 0.4282\n",
      "validation/sym_rel_regret_mean: 0.1434\n",
      "train/objective_mean: 3.4738\n",
      "train/loss_mean: 3.2933\n",
      "train/sym_rel_regret_mean: 0.0647\n",
      "validation/mse_mean: 3.0537\n",
      "validation/arc_costs_mean: 0.7422\n",
      "validation/rel_regret_mean: 0.5264\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 3.2610\n",
      "train/solver_calls_mean: 1869.8182\n",
      "train/rel_regret_mean: 0.1657\n",
      "validation/objective_mean: 4.4307\n",
      "validation/abs_regret_mean: 1.1994\n",
      "Validation evaluation (abs_regret): 0.33561816811561584\n",
      "New best validation evaluation (abs_regret): 0.33561816811561584 (was 0.4147034287452698)\n",
      "Epoch: 3/3\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 0.4086\n",
      "validation/sym_rel_regret_mean: 0.1434\n",
      "train/objective_mean: 3.4526\n",
      "train/loss_mean: 3.1472\n",
      "train/sym_rel_regret_mean: 0.0619\n",
      "validation/mse_mean: 3.0537\n",
      "validation/arc_costs_mean: 0.7422\n",
      "validation/rel_regret_mean: 0.5264\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 3.2395\n",
      "train/solver_calls_mean: 2719.8182\n",
      "train/rel_regret_mean: 0.1579\n",
      "validation/objective_mean: 4.4307\n",
      "validation/abs_regret_mean: 1.1994\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 0.4086\n",
      "validation/sym_rel_regret_mean: 0.1218\n",
      "train/objective_mean: 3.4526\n",
      "train/loss_mean: 3.1472\n",
      "train/sym_rel_regret_mean: 0.0619\n",
      "validation/mse_mean: 3.0187\n",
      "validation/arc_costs_mean: 0.7323\n",
      "validation/rel_regret_mean: 0.4305\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 3.2395\n",
      "train/solver_calls_mean: 2719.8182\n",
      "train/rel_regret_mean: 0.1579\n",
      "validation/objective_mean: 4.2360\n",
      "validation/abs_regret_mean: 1.0048\n",
      "Validation evaluation (abs_regret): 0.42090854048728943\n",
      "Training finished. Evaluating on the test set...\n",
      "Problem mode set to: test\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.1218\n",
      "train/loss_mean: 3.1472\n",
      "test/mse_mean: 2.4907\n",
      "test/objective_mean: 3.4519\n",
      "test/sym_rel_regret_mean: 0.0639\n",
      "validation/abs_regret_mean: 1.0048\n",
      "validation/select_arc_mean: 0.2000\n",
      "test/arc_costs_mean: 0.6975\n",
      "validation/mse_mean: 3.0187\n",
      "test/rel_regret_mean: 0.1607\n",
      "train/solver_calls_mean: 2719.8182\n",
      "train/abs_regret_mean: 0.4086\n",
      "train/sym_rel_regret_mean: 0.0619\n",
      "train/objective_mean: 3.4526\n",
      "test/select_arc_mean: 0.2000\n",
      "validation/arc_costs_mean: 0.7323\n",
      "validation/rel_regret_mean: 0.4305\n",
      "train/grad_norm_mean: 3.2395\n",
      "train/rel_regret_mean: 0.1579\n",
      "validation/objective_mean: 4.2360\n",
      "test/abs_regret_mean: 0.3491\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "np.float32(0.33561817)"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from src.problem import Problem\n",
    "from src.registries.data import get_data\n",
    "from src.registries.decision_makers import make_decision_maker\n",
    "from src.registries.models import make_model\n",
    "from src.runner import Runner\n",
    "\n",
    "model, _ = make_model(\"shortest_path\")\n",
    "data, _ = get_data(\"shortest_path\")\n",
    "problem = Problem(data_dict=data, opt_model=model)\n",
    "decision_maker, _ = make_decision_maker(problem, \"SPO+ linear\", learning_rate=0.1)  # adjust learning rate\n",
    "runner = Runner(decision_maker, num_epochs=3, use_wandb=False)\n",
    "runner.run()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "28f0794be60a055c",
   "metadata": {},
   "source": "The `make_decision_maker`, `make_model` and `get_data` methods above return the used configuration as a second argument, such that it can be saved with the results."
  },
  {
   "cell_type": "markdown",
   "id": "f465a3abcc69e5f",
   "metadata": {},
   "source": [
    "## 2.2 Configs and utils\n",
    "Configs are most easily defined using as a `.yml` file (though it is also possible to directly define dictionaries). Below we load an example config that for the `model`, `data` and `decision_maker` specifies a name from the registries."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "71de1686f11b2801",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T13:41:42.454345Z",
     "start_time": "2025-10-01T13:41:42.451379Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "model: {'name': 'shortest_path'}\n",
      "data: {'name': 'shortest_path', 'num_data': 250}\n",
      "runner: {'num_epochs': 5, 'use_wandb': False, 'save_best': True, 'experiments_folder': 'results/', 'seed': 5}\n",
      "problem: {'train_ratio': 0.75, 'val_ratio': 0.15, 'seed': 5}\n",
      "decision_maker: {'name': 'SPO+ linear', 'learning_rate': 0.005}\n"
     ]
    }
   ],
   "source": [
    "import yaml\n",
    "\n",
    "yaml_dir = \"configs/shortest_path.yml\"\n",
    "config = yaml.safe_load(open(yaml_dir))\n",
    "for key, value in config.items():\n",
    "    print(f\"{key}: {value}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "882e5142e68ac50e",
   "metadata": {},
   "source": "Using configs we can directly run experiments with the `run` method from `src.utils.experiments`."
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "e42463eeb16812b3",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T13:48:52.958211Z",
     "start_time": "2025-10-01T13:48:52.441695Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Set parameter FeasibilityTol to value 1e-06\n",
      "Generating data using shortest_path\n",
      "Computing optimal decisions for the entire dataset...\n",
      "Optimal decisions computed and added to dataset.\n",
      "Computing optimal objectives for the entire dataset...\n",
      "Optimal objectives computed and added to dataset.\n",
      "Shuffling indices before splitting...\n",
      "Dataset split completed: Train=187, Validation=37, Test=26\n",
      "Problem mode set to: train\n",
      "Problem mode set to: train\n",
      "Num of cores: 1\n",
      "Epoch 0/5: Starting initial validation...\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3749\n",
      "validation/mse_mean: 4.5052\n",
      "validation/arc_costs_mean: 0.7622\n",
      "validation/rel_regret_mean: 1.4082\n",
      "validation/select_arc_mean: 0.2000\n",
      "validation/objective_mean: 8.9562\n",
      "validation/abs_regret_mean: 5.0706\n",
      "Initial best validation metric (abs_regret): 5.070620536804199\n",
      "Starting training...\n",
      "Epoch: 1/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 3.4123\n",
      "validation/sym_rel_regret_mean: 0.3749\n",
      "train/objective_mean: 6.5024\n",
      "train/loss_mean: 11.8390\n",
      "train/sym_rel_regret_mean: 0.3383\n",
      "validation/mse_mean: 4.5052\n",
      "validation/arc_costs_mean: 0.7622\n",
      "validation/rel_regret_mean: 1.4082\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.6707\n",
      "train/solver_calls_mean: 148.1667\n",
      "train/rel_regret_mean: 1.3304\n",
      "validation/objective_mean: 8.9562\n",
      "validation/abs_regret_mean: 5.0706\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 3.4123\n",
      "validation/sym_rel_regret_mean: 0.3653\n",
      "train/objective_mean: 6.5024\n",
      "train/loss_mean: 11.8390\n",
      "train/sym_rel_regret_mean: 0.3383\n",
      "validation/mse_mean: 4.4398\n",
      "validation/arc_costs_mean: 0.7632\n",
      "validation/rel_regret_mean: 1.3430\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.6707\n",
      "train/solver_calls_mean: 148.1667\n",
      "train/rel_regret_mean: 1.3304\n",
      "validation/objective_mean: 8.7412\n",
      "validation/abs_regret_mean: 4.8556\n",
      "Validation evaluation (abs_regret): 4.640624046325684\n",
      "New best validation evaluation (abs_regret): 4.640624046325684 (was 5.070620536804199)\n",
      "Epoch: 2/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 3.2558\n",
      "validation/sym_rel_regret_mean: 0.3653\n",
      "train/objective_mean: 6.3473\n",
      "train/loss_mean: 11.1987\n",
      "train/sym_rel_regret_mean: 0.3294\n",
      "validation/mse_mean: 4.4398\n",
      "validation/arc_costs_mean: 0.7632\n",
      "validation/rel_regret_mean: 1.3430\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.5798\n",
      "train/solver_calls_mean: 260.1667\n",
      "train/rel_regret_mean: 1.2911\n",
      "validation/objective_mean: 8.7412\n",
      "validation/abs_regret_mean: 4.8556\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 3.2558\n",
      "validation/sym_rel_regret_mean: 0.3593\n",
      "train/objective_mean: 6.3473\n",
      "train/loss_mean: 11.1987\n",
      "train/sym_rel_regret_mean: 0.3294\n",
      "validation/mse_mean: 4.3795\n",
      "validation/arc_costs_mean: 0.7641\n",
      "validation/rel_regret_mean: 1.3184\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.5798\n",
      "train/solver_calls_mean: 260.1667\n",
      "train/rel_regret_mean: 1.2911\n",
      "validation/objective_mean: 8.5981\n",
      "validation/abs_regret_mean: 4.7126\n",
      "Validation evaluation (abs_regret): 4.426492214202881\n",
      "New best validation evaluation (abs_regret): 4.426492214202881 (was 4.640624046325684)\n",
      "Epoch: 3/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 3.0411\n",
      "validation/sym_rel_regret_mean: 0.3593\n",
      "train/objective_mean: 6.1363\n",
      "train/loss_mean: 10.5912\n",
      "train/sym_rel_regret_mean: 0.3147\n",
      "validation/mse_mean: 4.3795\n",
      "validation/arc_costs_mean: 0.7641\n",
      "validation/rel_regret_mean: 1.3184\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.5305\n",
      "train/solver_calls_mean: 372.1667\n",
      "train/rel_regret_mean: 1.2123\n",
      "validation/objective_mean: 8.5981\n",
      "validation/abs_regret_mean: 4.7126\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 3.0411\n",
      "validation/sym_rel_regret_mean: 0.3455\n",
      "train/objective_mean: 6.1363\n",
      "train/loss_mean: 10.5912\n",
      "train/sym_rel_regret_mean: 0.3147\n",
      "validation/mse_mean: 4.3218\n",
      "validation/arc_costs_mean: 0.7649\n",
      "validation/rel_regret_mean: 1.2549\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.5305\n",
      "train/solver_calls_mean: 372.1667\n",
      "train/rel_regret_mean: 1.2123\n",
      "validation/objective_mean: 8.2519\n",
      "validation/abs_regret_mean: 4.3664\n",
      "Validation evaluation (abs_regret): 3.3276705741882324\n",
      "New best validation evaluation (abs_regret): 3.3276705741882324 (was 4.426492214202881)\n",
      "Epoch: 4/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.8326\n",
      "validation/sym_rel_regret_mean: 0.3455\n",
      "train/objective_mean: 5.9283\n",
      "train/loss_mean: 9.9969\n",
      "train/sym_rel_regret_mean: 0.2988\n",
      "validation/mse_mean: 4.3218\n",
      "validation/arc_costs_mean: 0.7649\n",
      "validation/rel_regret_mean: 1.2549\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.3760\n",
      "train/solver_calls_mean: 484.1667\n",
      "train/rel_regret_mean: 1.1266\n",
      "validation/objective_mean: 8.2519\n",
      "validation/abs_regret_mean: 4.3664\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.8326\n",
      "validation/sym_rel_regret_mean: 0.3283\n",
      "train/objective_mean: 5.9283\n",
      "train/loss_mean: 9.9969\n",
      "train/sym_rel_regret_mean: 0.2988\n",
      "validation/mse_mean: 4.2671\n",
      "validation/arc_costs_mean: 0.7659\n",
      "validation/rel_regret_mean: 1.1711\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.3760\n",
      "train/solver_calls_mean: 484.1667\n",
      "train/rel_regret_mean: 1.1266\n",
      "validation/objective_mean: 7.9812\n",
      "validation/abs_regret_mean: 4.0957\n",
      "Validation evaluation (abs_regret): 3.012985944747925\n",
      "New best validation evaluation (abs_regret): 3.012985944747925 (was 3.3276705741882324)\n",
      "Epoch: 5/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.6555\n",
      "validation/sym_rel_regret_mean: 0.3283\n",
      "train/objective_mean: 5.7518\n",
      "train/loss_mean: 9.4416\n",
      "train/sym_rel_regret_mean: 0.2848\n",
      "validation/mse_mean: 4.2671\n",
      "validation/arc_costs_mean: 0.7659\n",
      "validation/rel_regret_mean: 1.1711\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.2495\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/rel_regret_mean: 1.0541\n",
      "validation/objective_mean: 7.9812\n",
      "validation/abs_regret_mean: 4.0957\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.6555\n",
      "validation/sym_rel_regret_mean: 0.3135\n",
      "train/objective_mean: 5.7518\n",
      "train/loss_mean: 9.4416\n",
      "train/sym_rel_regret_mean: 0.2848\n",
      "validation/mse_mean: 4.2151\n",
      "validation/arc_costs_mean: 0.7669\n",
      "validation/rel_regret_mean: 1.1020\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.2495\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/rel_regret_mean: 1.0541\n",
      "validation/objective_mean: 7.7591\n",
      "validation/abs_regret_mean: 3.8735\n",
      "Validation evaluation (abs_regret): 2.762871265411377\n",
      "New best validation evaluation (abs_regret): 2.762871265411377 (was 3.012985944747925)\n",
      "Training finished. Evaluating on the test set...\n",
      "Problem mode set to: test\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3135\n",
      "train/loss_mean: 9.4416\n",
      "test/mse_mean: 2.2066\n",
      "test/objective_mean: 5.3978\n",
      "test/sym_rel_regret_mean: 0.2255\n",
      "validation/abs_regret_mean: 3.8735\n",
      "validation/select_arc_mean: 0.2000\n",
      "test/arc_costs_mean: 0.7694\n",
      "validation/mse_mean: 4.2151\n",
      "test/rel_regret_mean: 0.7104\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/abs_regret_mean: 2.6555\n",
      "train/sym_rel_regret_mean: 0.2848\n",
      "train/objective_mean: 5.7518\n",
      "test/select_arc_mean: 0.2000\n",
      "validation/arc_costs_mean: 0.7669\n",
      "validation/rel_regret_mean: 1.1020\n",
      "train/grad_norm_mean: 5.2495\n",
      "train/rel_regret_mean: 1.0541\n",
      "validation/objective_mean: 7.7591\n",
      "test/abs_regret_mean: 2.4624\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "np.float32(2.7628713)"
      ]
     },
     "execution_count": 23,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from src.utils.experiments import run\n",
    "\n",
    "run(config)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "484dda30559f7d23",
   "metadata": {},
   "source": "To set up a more extended set of experiments, one can use the base config and update only parts of the config by using `update_config`."
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "18f5aa1d82fa6fe3",
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-01T18:03:00.609992Z",
     "start_time": "2025-10-01T18:02:57.886588Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Set parameter FeasibilityTol to value 1e-06\n",
      "Generating data using shortest_path\n",
      "Computing optimal decisions for the entire dataset...\n",
      "Optimal decisions computed and added to dataset.\n",
      "Computing optimal objectives for the entire dataset...\n",
      "Optimal objectives computed and added to dataset.\n",
      "Shuffling indices before splitting...\n",
      "Dataset split completed: Train=187, Validation=37, Test=26\n",
      "Problem mode set to: train\n",
      "Problem mode set to: train\n",
      "Num of cores: 1\n",
      "Epoch 0/5: Starting initial validation...\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3020\n",
      "validation/mse_mean: 2.3372\n",
      "validation/arc_costs_mean: 0.8379\n",
      "validation/rel_regret_mean: 1.0252\n",
      "validation/select_arc_mean: 0.2000\n",
      "validation/objective_mean: 7.9080\n",
      "validation/abs_regret_mean: 3.9899\n",
      "Initial best validation metric (abs_regret): 3.9898881912231445\n",
      "Starting training...\n",
      "Epoch: 1/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.6908\n",
      "validation/sym_rel_regret_mean: 0.3020\n",
      "train/objective_mean: 5.8365\n",
      "train/loss_mean: 10.7902\n",
      "train/sym_rel_regret_mean: 0.2926\n",
      "validation/mse_mean: 2.3372\n",
      "validation/arc_costs_mean: 0.8379\n",
      "validation/rel_regret_mean: 1.0252\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 6.5378\n",
      "train/solver_calls_mean: 148.1667\n",
      "train/rel_regret_mean: 1.1095\n",
      "validation/objective_mean: 7.9080\n",
      "validation/abs_regret_mean: 3.9899\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.6908\n",
      "validation/sym_rel_regret_mean: 0.2846\n",
      "train/objective_mean: 5.8365\n",
      "train/loss_mean: 10.7902\n",
      "train/sym_rel_regret_mean: 0.2926\n",
      "validation/mse_mean: 2.2947\n",
      "validation/arc_costs_mean: 0.8393\n",
      "validation/rel_regret_mean: 0.9382\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 6.5378\n",
      "train/solver_calls_mean: 148.1667\n",
      "train/rel_regret_mean: 1.1095\n",
      "validation/objective_mean: 7.4548\n",
      "validation/abs_regret_mean: 3.5367\n",
      "Validation evaluation (abs_regret): 3.083587646484375\n",
      "New best validation evaluation (abs_regret): 3.083587646484375 (was 3.9898881912231445)\n",
      "Epoch: 2/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.4608\n",
      "validation/sym_rel_regret_mean: 0.2846\n",
      "train/objective_mean: 5.6046\n",
      "train/loss_mean: 10.0271\n",
      "train/sym_rel_regret_mean: 0.2804\n",
      "validation/mse_mean: 2.2947\n",
      "validation/arc_costs_mean: 0.8393\n",
      "validation/rel_regret_mean: 0.9382\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 6.3082\n",
      "train/solver_calls_mean: 260.1667\n",
      "train/rel_regret_mean: 1.0375\n",
      "validation/objective_mean: 7.4548\n",
      "validation/abs_regret_mean: 3.5367\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.4608\n",
      "validation/sym_rel_regret_mean: 0.2673\n",
      "train/objective_mean: 5.6046\n",
      "train/loss_mean: 10.0271\n",
      "train/sym_rel_regret_mean: 0.2804\n",
      "validation/mse_mean: 2.2573\n",
      "validation/arc_costs_mean: 0.8408\n",
      "validation/rel_regret_mean: 0.8581\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 6.3082\n",
      "train/solver_calls_mean: 260.1667\n",
      "train/rel_regret_mean: 1.0375\n",
      "validation/objective_mean: 7.1215\n",
      "validation/abs_regret_mean: 3.2034\n",
      "Validation evaluation (abs_regret): 2.5368452072143555\n",
      "New best validation evaluation (abs_regret): 2.5368452072143555 (was 3.083587646484375)\n",
      "Epoch: 3/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.3045\n",
      "validation/sym_rel_regret_mean: 0.2673\n",
      "train/objective_mean: 5.4559\n",
      "train/loss_mean: 9.3657\n",
      "train/sym_rel_regret_mean: 0.2713\n",
      "validation/mse_mean: 2.2573\n",
      "validation/arc_costs_mean: 0.8408\n",
      "validation/rel_regret_mean: 0.8581\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 6.1346\n",
      "train/solver_calls_mean: 372.1667\n",
      "train/rel_regret_mean: 0.9930\n",
      "validation/objective_mean: 7.1215\n",
      "validation/abs_regret_mean: 3.2034\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.3045\n",
      "validation/sym_rel_regret_mean: 0.2508\n",
      "train/objective_mean: 5.4559\n",
      "train/loss_mean: 9.3657\n",
      "train/sym_rel_regret_mean: 0.2713\n",
      "validation/mse_mean: 2.2236\n",
      "validation/arc_costs_mean: 0.8423\n",
      "validation/rel_regret_mean: 0.7941\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 6.1346\n",
      "train/solver_calls_mean: 372.1667\n",
      "train/rel_regret_mean: 0.9930\n",
      "validation/objective_mean: 6.8839\n",
      "validation/abs_regret_mean: 2.9658\n",
      "Validation evaluation (abs_regret): 2.252972364425659\n",
      "New best validation evaluation (abs_regret): 2.252972364425659 (was 2.5368452072143555)\n",
      "Epoch: 4/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.1268\n",
      "validation/sym_rel_regret_mean: 0.2508\n",
      "train/objective_mean: 5.2749\n",
      "train/loss_mean: 8.7415\n",
      "train/sym_rel_regret_mean: 0.2566\n",
      "validation/mse_mean: 2.2236\n",
      "validation/arc_costs_mean: 0.8423\n",
      "validation/rel_regret_mean: 0.7941\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.9854\n",
      "train/solver_calls_mean: 484.1667\n",
      "train/rel_regret_mean: 0.9239\n",
      "validation/objective_mean: 6.8839\n",
      "validation/abs_regret_mean: 2.9658\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.1268\n",
      "validation/sym_rel_regret_mean: 0.2337\n",
      "train/objective_mean: 5.2749\n",
      "train/loss_mean: 8.7415\n",
      "train/sym_rel_regret_mean: 0.2566\n",
      "validation/mse_mean: 2.1929\n",
      "validation/arc_costs_mean: 0.8439\n",
      "validation/rel_regret_mean: 0.7230\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.9854\n",
      "train/solver_calls_mean: 484.1667\n",
      "train/rel_regret_mean: 0.9239\n",
      "validation/objective_mean: 6.6688\n",
      "validation/abs_regret_mean: 2.7507\n",
      "Validation evaluation (abs_regret): 1.8901211023330688\n",
      "New best validation evaluation (abs_regret): 1.8901211023330688 (was 2.252972364425659)\n",
      "Epoch: 5/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 1.9731\n",
      "validation/sym_rel_regret_mean: 0.2337\n",
      "train/objective_mean: 5.1195\n",
      "train/loss_mean: 8.1695\n",
      "train/sym_rel_regret_mean: 0.2404\n",
      "validation/mse_mean: 2.1929\n",
      "validation/arc_costs_mean: 0.8439\n",
      "validation/rel_regret_mean: 0.7230\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.8061\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/rel_regret_mean: 0.8545\n",
      "validation/objective_mean: 6.6688\n",
      "validation/abs_regret_mean: 2.7507\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 1.9731\n",
      "validation/sym_rel_regret_mean: 0.2175\n",
      "train/objective_mean: 5.1195\n",
      "train/loss_mean: 8.1695\n",
      "train/sym_rel_regret_mean: 0.2404\n",
      "validation/mse_mean: 2.1650\n",
      "validation/arc_costs_mean: 0.8455\n",
      "validation/rel_regret_mean: 0.6596\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 5.8061\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/rel_regret_mean: 0.8545\n",
      "validation/objective_mean: 6.4554\n",
      "validation/abs_regret_mean: 2.5374\n",
      "Validation evaluation (abs_regret): 1.4707140922546387\n",
      "New best validation evaluation (abs_regret): 1.4707140922546387 (was 1.8901211023330688)\n",
      "Training finished. Evaluating on the test set...\n",
      "Problem mode set to: test\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2175\n",
      "train/loss_mean: 8.1695\n",
      "test/mse_mean: 1.8271\n",
      "test/objective_mean: 3.7426\n",
      "test/sym_rel_regret_mean: 0.1794\n",
      "validation/abs_regret_mean: 2.5374\n",
      "validation/select_arc_mean: 0.2000\n",
      "test/arc_costs_mean: 0.9246\n",
      "validation/mse_mean: 2.1650\n",
      "test/rel_regret_mean: 0.5429\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/abs_regret_mean: 1.9731\n",
      "train/sym_rel_regret_mean: 0.2404\n",
      "train/objective_mean: 5.1195\n",
      "test/select_arc_mean: 0.2000\n",
      "validation/arc_costs_mean: 0.8455\n",
      "validation/rel_regret_mean: 0.6596\n",
      "train/grad_norm_mean: 5.8061\n",
      "train/rel_regret_mean: 0.8545\n",
      "validation/objective_mean: 6.4554\n",
      "test/abs_regret_mean: 0.8020\n",
      "Set parameter FeasibilityTol to value 1e-06\n",
      "Generating data using shortest_path\n",
      "Computing optimal decisions for the entire dataset...\n",
      "Optimal decisions computed and added to dataset.\n",
      "Computing optimal objectives for the entire dataset...\n",
      "Optimal objectives computed and added to dataset.\n",
      "Shuffling indices before splitting...\n",
      "Dataset split completed: Train=187, Validation=37, Test=26\n",
      "Problem mode set to: train\n",
      "Problem mode set to: train\n",
      "Num of cores: 1\n",
      "Epoch 0/5: Starting initial validation...\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3020\n",
      "validation/mse_mean: 2.3372\n",
      "validation/arc_costs_mean: 0.8379\n",
      "validation/rel_regret_mean: 1.0252\n",
      "validation/select_arc_mean: 0.2000\n",
      "validation/objective_mean: 7.9080\n",
      "validation/abs_regret_mean: 3.9899\n",
      "Initial best validation metric (abs_regret): 3.9898881912231445\n",
      "Starting training...\n",
      "Epoch: 1/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.8377\n",
      "validation/sym_rel_regret_mean: 0.3020\n",
      "train/objective_mean: 5.9835\n",
      "train/loss_mean: 6.8692\n",
      "train/sym_rel_regret_mean: 0.2979\n",
      "validation/mse_mean: 2.3372\n",
      "validation/arc_costs_mean: 0.8379\n",
      "validation/rel_regret_mean: 1.0252\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.2794\n",
      "train/solver_calls_mean: 148.1667\n",
      "train/rel_regret_mean: 1.1443\n",
      "validation/objective_mean: 7.9080\n",
      "validation/abs_regret_mean: 3.9899\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.8377\n",
      "validation/sym_rel_regret_mean: 0.2924\n",
      "train/objective_mean: 5.9835\n",
      "train/loss_mean: 6.8692\n",
      "train/sym_rel_regret_mean: 0.2979\n",
      "validation/mse_mean: 2.2990\n",
      "validation/arc_costs_mean: 0.8396\n",
      "validation/rel_regret_mean: 0.9810\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.2794\n",
      "train/solver_calls_mean: 148.1667\n",
      "train/rel_regret_mean: 1.1443\n",
      "validation/objective_mean: 7.7732\n",
      "validation/abs_regret_mean: 3.8552\n",
      "Validation evaluation (abs_regret): 3.7204201221466064\n",
      "New best validation evaluation (abs_regret): 3.7204201221466064 (was 3.9898881912231445)\n",
      "Epoch: 2/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.6506\n",
      "validation/sym_rel_regret_mean: 0.2924\n",
      "train/objective_mean: 5.7944\n",
      "train/loss_mean: 6.6645\n",
      "train/sym_rel_regret_mean: 0.2897\n",
      "validation/mse_mean: 2.2990\n",
      "validation/arc_costs_mean: 0.8396\n",
      "validation/rel_regret_mean: 0.9810\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.2079\n",
      "train/solver_calls_mean: 260.1667\n",
      "train/rel_regret_mean: 1.0915\n",
      "validation/objective_mean: 7.7732\n",
      "validation/abs_regret_mean: 3.8552\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.6506\n",
      "validation/sym_rel_regret_mean: 0.2736\n",
      "train/objective_mean: 5.7944\n",
      "train/loss_mean: 6.6645\n",
      "train/sym_rel_regret_mean: 0.2897\n",
      "validation/mse_mean: 2.2640\n",
      "validation/arc_costs_mean: 0.8412\n",
      "validation/rel_regret_mean: 0.8980\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.2079\n",
      "train/solver_calls_mean: 260.1667\n",
      "train/rel_regret_mean: 1.0915\n",
      "validation/objective_mean: 7.3671\n",
      "validation/abs_regret_mean: 3.4490\n",
      "Validation evaluation (abs_regret): 2.6368212699890137\n",
      "New best validation evaluation (abs_regret): 2.6368212699890137 (was 3.7204201221466064)\n",
      "Epoch: 3/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.4822\n",
      "validation/sym_rel_regret_mean: 0.2736\n",
      "train/objective_mean: 5.6335\n",
      "train/loss_mean: 6.5385\n",
      "train/sym_rel_regret_mean: 0.2798\n",
      "validation/mse_mean: 2.2640\n",
      "validation/arc_costs_mean: 0.8412\n",
      "validation/rel_regret_mean: 0.8980\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.1539\n",
      "train/solver_calls_mean: 372.1667\n",
      "train/rel_regret_mean: 1.0401\n",
      "validation/objective_mean: 7.3671\n",
      "validation/abs_regret_mean: 3.4490\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.4822\n",
      "validation/sym_rel_regret_mean: 0.2560\n",
      "train/objective_mean: 5.6335\n",
      "train/loss_mean: 6.5385\n",
      "train/sym_rel_regret_mean: 0.2798\n",
      "validation/mse_mean: 2.2318\n",
      "validation/arc_costs_mean: 0.8427\n",
      "validation/rel_regret_mean: 0.8291\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.1539\n",
      "train/solver_calls_mean: 372.1667\n",
      "train/rel_regret_mean: 1.0401\n",
      "validation/objective_mean: 7.0815\n",
      "validation/abs_regret_mean: 3.1635\n",
      "Validation evaluation (abs_regret): 2.3066790103912354\n",
      "New best validation evaluation (abs_regret): 2.3066790103912354 (was 2.6368212699890137)\n",
      "Epoch: 4/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.3052\n",
      "validation/sym_rel_regret_mean: 0.2560\n",
      "train/objective_mean: 5.4533\n",
      "train/loss_mean: 6.3538\n",
      "train/sym_rel_regret_mean: 0.2692\n",
      "validation/mse_mean: 2.2318\n",
      "validation/arc_costs_mean: 0.8427\n",
      "validation/rel_regret_mean: 0.8291\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.1029\n",
      "train/solver_calls_mean: 484.1667\n",
      "train/rel_regret_mean: 0.9910\n",
      "validation/objective_mean: 7.0815\n",
      "validation/abs_regret_mean: 3.1635\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.3052\n",
      "validation/sym_rel_regret_mean: 0.2392\n",
      "train/objective_mean: 5.4533\n",
      "train/loss_mean: 6.3538\n",
      "train/sym_rel_regret_mean: 0.2692\n",
      "validation/mse_mean: 2.2020\n",
      "validation/arc_costs_mean: 0.8442\n",
      "validation/rel_regret_mean: 0.7577\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.1029\n",
      "train/solver_calls_mean: 484.1667\n",
      "train/rel_regret_mean: 0.9910\n",
      "validation/objective_mean: 6.8533\n",
      "validation/abs_regret_mean: 2.9352\n",
      "Validation evaluation (abs_regret): 2.02203631401062\n",
      "New best validation evaluation (abs_regret): 2.02203631401062 (was 2.3066790103912354)\n",
      "Epoch: 5/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.1462\n",
      "validation/sym_rel_regret_mean: 0.2392\n",
      "train/objective_mean: 5.2927\n",
      "train/loss_mean: 6.1865\n",
      "train/sym_rel_regret_mean: 0.2555\n",
      "validation/mse_mean: 2.2020\n",
      "validation/arc_costs_mean: 0.8442\n",
      "validation/rel_regret_mean: 0.7577\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.0330\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/rel_regret_mean: 0.9298\n",
      "validation/objective_mean: 6.8533\n",
      "validation/abs_regret_mean: 2.9352\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "train/abs_regret_mean: 2.1462\n",
      "validation/sym_rel_regret_mean: 0.2234\n",
      "train/objective_mean: 5.2927\n",
      "train/loss_mean: 6.1865\n",
      "train/sym_rel_regret_mean: 0.2555\n",
      "validation/mse_mean: 2.1750\n",
      "validation/arc_costs_mean: 0.8456\n",
      "validation/rel_regret_mean: 0.6922\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 2.0330\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/rel_regret_mean: 0.9298\n",
      "validation/objective_mean: 6.6156\n",
      "validation/abs_regret_mean: 2.6975\n",
      "Validation evaluation (abs_regret): 1.5090945959091187\n",
      "New best validation evaluation (abs_regret): 1.5090945959091187 (was 2.02203631401062)\n",
      "Training finished. Evaluating on the test set...\n",
      "Problem mode set to: test\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2234\n",
      "train/loss_mean: 6.1865\n",
      "test/mse_mean: 1.8451\n",
      "test/objective_mean: 3.9453\n",
      "test/sym_rel_regret_mean: 0.2012\n",
      "validation/abs_regret_mean: 2.6975\n",
      "validation/select_arc_mean: 0.2000\n",
      "test/arc_costs_mean: 0.9208\n",
      "validation/mse_mean: 2.1750\n",
      "test/rel_regret_mean: 0.6255\n",
      "train/solver_calls_mean: 596.1667\n",
      "train/abs_regret_mean: 2.1462\n",
      "train/sym_rel_regret_mean: 0.2555\n",
      "train/objective_mean: 5.2927\n",
      "test/select_arc_mean: 0.2000\n",
      "validation/arc_costs_mean: 0.8456\n",
      "validation/rel_regret_mean: 0.6922\n",
      "train/grad_norm_mean: 2.0330\n",
      "train/rel_regret_mean: 0.9298\n",
      "validation/objective_mean: 6.6156\n",
      "test/abs_regret_mean: 1.0047\n",
      "Set parameter FeasibilityTol to value 1e-06\n",
      "Generating data using shortest_path\n",
      "Computing optimal decisions for the entire dataset...\n",
      "Optimal decisions computed and added to dataset.\n",
      "Computing optimal objectives for the entire dataset...\n",
      "Optimal objectives computed and added to dataset.\n",
      "Shuffling indices before splitting...\n",
      "Dataset split completed: Train=187, Validation=37, Test=26\n",
      "Problem mode set to: train\n",
      "Problem mode set to: train\n",
      "Epoch 0/5: Starting initial validation...\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3020\n",
      "validation/mse_mean: 2.3372\n",
      "validation/arc_costs_mean: 0.8379\n",
      "validation/rel_regret_mean: 1.0252\n",
      "validation/select_arc_mean: 0.2000\n",
      "validation/objective_mean: 7.9080\n",
      "validation/abs_regret_mean: 3.9899\n",
      "Initial best validation metric (abs_regret): 3.9898881912231445\n",
      "Starting training...\n",
      "Epoch: 1/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.3020\n",
      "train/loss_mean: 2.8444\n",
      "validation/mse_mean: 2.3372\n",
      "validation/arc_costs_mean: 0.8379\n",
      "validation/rel_regret_mean: 1.0252\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.9549\n",
      "train/solver_calls_mean: 37.0000\n",
      "validation/objective_mean: 7.9080\n",
      "validation/abs_regret_mean: 3.9899\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2955\n",
      "train/loss_mean: 2.8444\n",
      "validation/mse_mean: 2.2571\n",
      "validation/arc_costs_mean: 0.8454\n",
      "validation/rel_regret_mean: 1.0024\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.9549\n",
      "train/solver_calls_mean: 37.0000\n",
      "validation/objective_mean: 7.8244\n",
      "validation/abs_regret_mean: 3.9063\n",
      "Validation evaluation (abs_regret): 3.8226499557495117\n",
      "New best validation evaluation (abs_regret): 3.8226499557495117 (was 3.9898881912231445)\n",
      "Epoch: 2/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2955\n",
      "train/loss_mean: 2.7419\n",
      "validation/mse_mean: 2.2571\n",
      "validation/arc_costs_mean: 0.8454\n",
      "validation/rel_regret_mean: 1.0024\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.9360\n",
      "train/solver_calls_mean: 55.5000\n",
      "validation/objective_mean: 7.8244\n",
      "validation/abs_regret_mean: 3.9063\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2914\n",
      "train/loss_mean: 2.7419\n",
      "validation/mse_mean: 2.1812\n",
      "validation/arc_costs_mean: 0.8513\n",
      "validation/rel_regret_mean: 0.9837\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.9360\n",
      "train/solver_calls_mean: 55.5000\n",
      "validation/objective_mean: 7.7703\n",
      "validation/abs_regret_mean: 3.8522\n",
      "Validation evaluation (abs_regret): 3.7440361976623535\n",
      "New best validation evaluation (abs_regret): 3.7440361976623535 (was 3.8226499557495117)\n",
      "Epoch: 3/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2914\n",
      "train/loss_mean: 2.6594\n",
      "validation/mse_mean: 2.1812\n",
      "validation/arc_costs_mean: 0.8513\n",
      "validation/rel_regret_mean: 0.9837\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.9133\n",
      "train/solver_calls_mean: 74.0000\n",
      "validation/objective_mean: 7.7703\n",
      "validation/abs_regret_mean: 3.8522\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2837\n",
      "train/loss_mean: 2.6594\n",
      "validation/mse_mean: 2.1092\n",
      "validation/arc_costs_mean: 0.8579\n",
      "validation/rel_regret_mean: 0.9439\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.9133\n",
      "train/solver_calls_mean: 74.0000\n",
      "validation/objective_mean: 7.6018\n",
      "validation/abs_regret_mean: 3.6837\n",
      "Validation evaluation (abs_regret): 3.1782002449035645\n",
      "New best validation evaluation (abs_regret): 3.1782002449035645 (was 3.7440361976623535)\n",
      "Epoch: 4/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2837\n",
      "train/loss_mean: 2.5935\n",
      "validation/mse_mean: 2.1092\n",
      "validation/arc_costs_mean: 0.8579\n",
      "validation/rel_regret_mean: 0.9439\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.8948\n",
      "train/solver_calls_mean: 92.5000\n",
      "validation/objective_mean: 7.6018\n",
      "validation/abs_regret_mean: 3.6837\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2745\n",
      "train/loss_mean: 2.5935\n",
      "validation/mse_mean: 2.0417\n",
      "validation/arc_costs_mean: 0.8638\n",
      "validation/rel_regret_mean: 0.9040\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.8948\n",
      "train/solver_calls_mean: 92.5000\n",
      "validation/objective_mean: 7.3846\n",
      "validation/abs_regret_mean: 3.4665\n",
      "Validation evaluation (abs_regret): 2.59779691696167\n",
      "New best validation evaluation (abs_regret): 2.59779691696167 (was 3.1782002449035645)\n",
      "Epoch: 5/5\n",
      "Problem mode set to: train\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2745\n",
      "train/loss_mean: 2.5165\n",
      "validation/mse_mean: 2.0417\n",
      "validation/arc_costs_mean: 0.8638\n",
      "validation/rel_regret_mean: 0.9040\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.8880\n",
      "train/solver_calls_mean: 111.0000\n",
      "validation/objective_mean: 7.3846\n",
      "validation/abs_regret_mean: 3.4665\n",
      "Problem mode set to: validation\n",
      "Epoch Results:\n",
      "validation/sym_rel_regret_mean: 0.2673\n",
      "train/loss_mean: 2.5165\n",
      "validation/mse_mean: 1.9777\n",
      "validation/arc_costs_mean: 0.8700\n",
      "validation/rel_regret_mean: 0.8707\n",
      "validation/select_arc_mean: 0.2000\n",
      "train/grad_norm_mean: 0.8880\n",
      "train/solver_calls_mean: 111.0000\n",
      "validation/objective_mean: 7.1984\n",
      "validation/abs_regret_mean: 3.2803\n",
      "Validation evaluation (abs_regret): 2.3491334915161133\n",
      "New best validation evaluation (abs_regret): 2.3491334915161133 (was 2.59779691696167)\n",
      "Training finished. Evaluating on the test set...\n",
      "Problem mode set to: test\n",
      "Epoch Results:\n",
      "test/arc_costs_mean: 0.8639\n",
      "validation/sym_rel_regret_mean: 0.2673\n",
      "train/loss_mean: 2.5165\n",
      "test/mse_mean: 1.3423\n",
      "validation/mse_mean: 1.9777\n",
      "test/sym_rel_regret_mean: 0.3036\n",
      "test/select_arc_mean: 0.2000\n",
      "validation/arc_costs_mean: 0.8700\n",
      "validation/rel_regret_mean: 0.8707\n",
      "validation/select_arc_mean: 0.2000\n",
      "test/objective_mean: 4.9862\n",
      "test/rel_regret_mean: 1.1638\n",
      "train/grad_norm_mean: 0.8880\n",
      "train/solver_calls_mean: 111.0000\n",
      "test/abs_regret_mean: 2.0456\n",
      "validation/objective_mean: 7.1984\n",
      "validation/abs_regret_mean: 3.2803\n"
     ]
    }
   ],
   "source": [
    "from src.utils.experiments import update_config\n",
    "\n",
    "experiment_kwargs = {\n",
    "    \"SPO+\": {},\n",
    "    \"PFYL\": {\n",
    "        \"decision_maker\": {\n",
    "            \"loss_function_str\": \"perturbedFenchelYoung\",\n",
    "        },\n",
    "    },\n",
    "    \"PFL\": {\n",
    "        \"decision_maker\": {\n",
    "            \"loss_function_str\": \"mse\",\n",
    "        }\n",
    "    },\n",
    "}\n",
    "\n",
    "seeds = list(range(1))\n",
    "for experiment_name, kwargs in experiment_kwargs.items():\n",
    "    for seed in seeds:\n",
    "        yaml_dir = \"configs/shortest_path.yml\"\n",
    "        config = yaml.safe_load(open(yaml_dir))\n",
    "        config[\"runner\"][\"experiment_name\"] = experiment_name\n",
    "        for key in config:\n",
    "            if isinstance(config[key], dict) and \"seed\" in config[key]:\n",
    "                config[key][\"seed\"] = seed\n",
    "        updated_config = update_config(config, kwargs)\n",
    "        run(updated_config)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 2
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "2.7.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
